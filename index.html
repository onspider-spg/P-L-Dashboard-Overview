<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SPG App ‚Äî Siam Palette Group</title>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{--bg:#09090b;--surface:#131316;--surface-2:#1a1a1f;--surface-3:#222228;--border:#27272a;--border-light:#333338;--text:#f4f4f5;--text-secondary:#a1a1aa;--text-muted:#71717a;--gold:#eab308;--gold-dim:rgba(234,179,8,.15);--green:#22c55e;--green-dim:rgba(34,197,94,.12);--red:#ef4444;--red-dim:rgba(239,68,68,.12);--blue:#3b82f6;--blue-dim:rgba(59,130,246,.12);--purple:#a78bfa;--orange:#f97316;--radius:12px;--radius-sm:8px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',-apple-system,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh}

/* ===== LOGIN ===== */
.login-overlay{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:1000;transition:opacity .4s}
.login-overlay.hidden{opacity:0;pointer-events:none}
.login-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:40px;width:100%;max-width:380px;text-align:center}
.login-logo{font-family:'Instrument Serif',serif;font-size:28px;margin-bottom:4px}
.login-sub{font-size:13px;color:var(--text-muted);margin-bottom:32px}
.form-group{text-align:left;margin-bottom:16px}
.form-label{display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;letter-spacing:.03em}
.form-input{width:100%;padding:10px 14px;background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:14px;font-family:inherit;outline:none;transition:border-color .2s}
.form-input:focus{border-color:var(--gold)}
.form-input::placeholder{color:var(--text-muted)}
select.form-input{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:36px}
select.form-input option{background:var(--surface);color:var(--text)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 20px;border-radius:var(--radius-sm);font-size:14px;font-weight:600;font-family:inherit;cursor:pointer;border:none;transition:all .15s}
.btn-gold{background:var(--gold);color:#000}.btn-gold:hover{background:#facc15}
.btn-green{background:var(--green);color:#fff}.btn-green:hover{opacity:.9}
.btn-red{background:var(--red);color:#fff}.btn-red:hover{opacity:.9}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text-secondary)}.btn-ghost:hover{background:var(--surface-2);color:var(--text)}
.btn-sm{padding:6px 14px;font-size:12px}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-full{width:100%}
.login-error{color:var(--red);font-size:12px;margin-top:12px;min-height:18px}

/* ===== APP LAYOUT ===== */
.app{display:flex;min-height:100vh;display:none}
.app.show{display:flex}
.sidebar{width:240px;background:var(--surface);border-right:1px solid var(--border);padding:24px 16px;position:fixed;top:0;left:0;bottom:0;overflow-y:auto;z-index:50;transition:transform .3s ease;display:flex;flex-direction:column}
.sidebar-logo{font-family:'Instrument Serif',serif;font-size:20px;padding:0 8px 20px;border-bottom:1px solid var(--border);margin-bottom:20px;display:flex;align-items:center;gap:10px}
.sidebar-logo .dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.sidebar-section{font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--text-muted);padding:16px 8px 8px}
.sidebar-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--radius-sm);font-size:13px;font-weight:500;color:var(--text-secondary);cursor:pointer;transition:all .15s;margin-bottom:2px;border:none;background:none;width:100%;text-align:left;font-family:inherit}
.sidebar-item:hover{background:var(--surface-2);color:var(--text)}
.sidebar-item.active{background:var(--gold-dim);color:var(--gold)}
.sidebar-item .icon{font-size:16px;width:20px;text-align:center}
.sidebar-user{padding:12px;border-top:1px solid var(--border);margin-top:auto}
.sidebar-user-name{font-size:13px;font-weight:600;color:var(--text)}
.sidebar-user-role{font-size:11px;color:var(--text-muted);margin-bottom:8px}
.main{flex:1;margin-left:240px;min-height:100vh}
.topbar{display:flex;justify-content:space-between;align-items:center;padding:16px 32px;border-bottom:1px solid var(--border);background:var(--surface);position:sticky;top:0;z-index:40}
.topbar-left{display:flex;align-items:center;gap:12px}
.topbar-title{font-size:15px;font-weight:600}
.topbar-right{display:flex;align-items:center;gap:12px}
.badge{display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:100px;font-size:12px}
.badge-surface{background:var(--surface-2);border:1px solid var(--border);color:var(--text-secondary)}
.badge-green{background:var(--green-dim);border:1px solid rgba(34,197,94,.25);font-size:11px;font-weight:600;color:var(--green);text-transform:uppercase;letter-spacing:.05em}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:blink 1.5s infinite}
.hamburger{display:none;background:none;border:none;cursor:pointer;padding:8px;border-radius:var(--radius-sm);flex-direction:column;gap:5px;justify-content:center;align-items:center;width:40px;height:40px}
.hamburger span{display:block;width:20px;height:2px;background:var(--text);border-radius:2px}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:45}
.sidebar-overlay.show{display:block}

/* ===== PAGES ===== */
.page{padding:28px 32px 60px;display:none}
.page.active{display:block;animation:fadeUp .3s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.section-title{font-family:'Instrument Serif',serif;font-size:24px;font-weight:400;margin-bottom:20px;display:flex;align-items:center;gap:10px}
.section-desc{font-size:13px;color:var(--text-muted);margin-bottom:24px;max-width:600px}
.data-source{display:inline-flex;align-items:center;gap:6px;font-size:11px;color:var(--text-muted);background:var(--surface-2);padding:4px 10px;border-radius:100px;margin-bottom:16px}
.data-source .gs{width:14px;height:14px;background:var(--green);border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:white}
.grid{display:grid;gap:16px;margin-bottom:24px}
.grid-4{grid-template-columns:repeat(4,1fr)}.grid-3{grid-template-columns:repeat(3,1fr)}.grid-2{grid-template-columns:repeat(2,1fr)}.grid-2-1{grid-template-columns:2fr 1fr}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px}
.card-title{font-size:13px;font-weight:500;color:var(--text-secondary)}
.card-icon{width:32px;height:32px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:16px}
.stat-value{font-size:28px;font-weight:700;letter-spacing:-.02em;margin-bottom:4px}
.stat-change{display:inline-flex;align-items:center;gap:4px;font-size:12px;font-weight:600;padding:2px 8px;border-radius:100px}
.stat-change.up{color:var(--green);background:var(--green-dim)}.stat-change.down{color:var(--red);background:var(--red-dim)}
.stat-sub{font-size:12px;color:var(--text-muted);margin-top:4px}
.chart-container{position:relative;width:100%;height:280px}
.chart-container-sm{position:relative;width:100%;height:200px}
.data-table{width:100%;border-collapse:collapse}
.data-table th{text-align:left;font-size:11px;font-weight:600;letter-spacing:.05em;text-transform:uppercase;color:var(--text-muted);padding:10px 12px;border-bottom:1px solid var(--border)}
.data-table td{padding:12px;font-size:13px;border-bottom:1px solid var(--border);color:var(--text-secondary)}
.data-table tr:last-child td{border-bottom:none}
.data-table tr:hover td{background:var(--surface-2)}
.brand-cell{display:flex;align-items:center;gap:10px;font-weight:600;color:var(--text)}
.brand-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.val-positive{color:var(--green)}.val-negative{color:var(--red)}
.pnl-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border);font-size:14px}
.pnl-row:last-child{border-bottom:none}
.pnl-label{color:var(--text-secondary)}.pnl-value{font-weight:600;font-variant-numeric:tabular-nums}
.pnl-row.total{border-top:2px solid var(--border-light);border-bottom:none;padding-top:16px;margin-top:4px}
.pnl-row.total .pnl-label{font-weight:700;color:var(--text)}.pnl-row.total .pnl-value{font-size:18px}
.alert-banner{display:flex;align-items:flex-start;gap:12px;padding:14px 20px;border-radius:var(--radius);margin-bottom:20px;font-size:13px;line-height:1.6}
.alert-warning{background:rgba(234,179,8,.08);border:1px solid rgba(234,179,8,.2);color:var(--gold)}
.alert-error{background:var(--red-dim);border:1px solid rgba(239,68,68,.2);color:var(--red)}
.alert-success{background:var(--green-dim);border:1px solid rgba(34,197,94,.2);color:var(--green)}
.alert-info{background:var(--blue-dim);border:1px solid rgba(59,130,246,.2);color:var(--blue)}
.heatmap{display:grid;grid-template-columns:120px repeat(7,1fr);gap:3px;font-size:11px}
.heatmap-label{display:flex;align-items:center;color:var(--text-muted);font-size:10px;padding-right:8px}
.heatmap-header{text-align:center;color:var(--text-muted);font-size:11px;font-weight:600;padding-bottom:6px}
.heatmap-cell{aspect-ratio:1;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:600;color:rgba(255,255,255,.7);min-height:36px;transition:transform .15s}
.heatmap-cell:hover{transform:scale(1.1);z-index:2}
.loading{display:flex;align-items:center;justify-content:center;padding:60px;color:var(--text-muted);font-size:14px;flex-direction:column;gap:12px}
.spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ===== FORM STYLES ===== */
.form-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:28px;max-width:700px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:16px}
.form-row-1{margin-bottom:16px}
.form-actions{display:flex;gap:12px;margin-top:24px;padding-top:20px;border-top:1px solid var(--border)}
.form-message{padding:10px 16px;border-radius:var(--radius-sm);font-size:13px;margin-bottom:16px}
.toast{position:fixed;top:20px;right:20px;padding:14px 24px;border-radius:var(--radius);font-size:13px;font-weight:500;z-index:9999;animation:slideIn .3s ease;box-shadow:0 8px 32px rgba(0,0,0,.3)}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
.toast-success{background:#166534;border:1px solid #22c55e;color:#bbf7d0}
.toast-error{background:#7f1d1d;border:1px solid #ef4444;color:#fecaca}

/* ===== USER TABLE ===== */
.user-badge{display:inline-block;padding:2px 10px;border-radius:100px;font-size:11px;font-weight:600}
.user-badge.admin{background:var(--gold-dim);color:var(--gold)}
.user-badge.editor{background:var(--blue-dim);color:var(--blue)}
.user-badge.viewer{background:var(--surface-2);color:var(--text-muted)}
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}
.status-dot.active{background:var(--green)}.status-dot.inactive{background:var(--red)}

/* ===== RESPONSIVE ===== */
@media(max-width:1100px){.grid-4{grid-template-columns:repeat(2,1fr)}.grid-3,.grid-2,.grid-2-1{grid-template-columns:1fr}.hamburger{display:flex}.sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0)}.main{margin-left:0}.form-row,.form-row-3{grid-template-columns:1fr}}
@media(max-width:640px){.grid-4{grid-template-columns:1fr 1fr}.page{padding:20px 16px 60px}.topbar{padding:12px 16px}.stat-value{font-size:22px}.card{padding:16px}.data-table th,.data-table td{padding:8px 6px;font-size:11px}.chart-container{height:220px}.login-box{padding:28px 20px;margin:16px}.sidebar{width:280px}.form-card{padding:20px}}
@media(max-width:400px){.grid-4{grid-template-columns:1fr}.stat-value{font-size:20px}}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
</style>
</head>
<body>

<!-- ============================================================ -->
<!-- LOGIN SCREEN -->
<!-- ============================================================ -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <div class="login-logo">üé® SPG App</div>
    <div class="login-sub">Siam Palette Group ‚Äî Management System</div>
    <div class="form-group">
      <label class="form-label">Username</label>
      <input type="text" class="form-input" id="loginUser" placeholder="username" autocomplete="username" autofocus>
    </div>
    <div class="form-group">
      <label class="form-label">Password</label>
      <input type="password" class="form-input" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
    </div>
    <button class="btn btn-gold btn-full" id="loginBtn" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- ============================================================ -->
<!-- MAIN APP -->
<!-- ============================================================ -->
<div class="app" id="mainApp">
<nav class="sidebar" id="sidebar">
  <div class="sidebar-logo"><span class="dot"></span>SPG App</div>

  <div class="sidebar-section">Dashboard</div>
  <button class="sidebar-item active" onclick="showPage('overview',this)"><span class="icon">üìä</span> Overview</button>
  <button class="sidebar-item" onclick="showPage('pnl',this)"><span class="icon">üí∞</span> P&L Statement</button>

  <div class="sidebar-section">Brands</div>
  <button class="sidebar-item" onclick="showPage('brands',this)"><span class="icon">üè™</span> All Brands</button>
  <button class="sidebar-item" onclick="showPage('melting',this)"><span class="icon">üßÄ</span> The Melting Cheese</button>

  <div class="sidebar-section">Traffic</div>
  <button class="sidebar-item" onclick="showPage('traffic',this)"><span class="icon">üö∂</span> Foot Traffic</button>
  <button class="sidebar-item" onclick="showPage('heatmap',this)"><span class="icon">üî•</span> Heatmap</button>

  <div class="sidebar-section">Marketing</div>
  <button class="sidebar-item" onclick="showPage('marketing',this)"><span class="icon">üì±</span> Social & Campaigns</button>

  <div class="sidebar-section" id="entrySection">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
  <button class="sidebar-item" id="entryDailyBtn" onclick="showPage('entry-daily',this)"><span class="icon">üìù</span> Daily Sales</button>
  <button class="sidebar-item" id="entrySocialBtn" onclick="showPage('entry-social',this)"><span class="icon">üì∏</span> Social Media</button>
  <button class="sidebar-item" id="entryCampaignBtn" onclick="showPage('entry-campaign',this)"><span class="icon">üì£</span> Campaign</button>

  <div class="sidebar-section" id="adminSection" style="display:none">Admin</div>
  <button class="sidebar-item" id="adminUsersBtn" style="display:none" onclick="showPage('admin-users',this)"><span class="icon">üë•</span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>

  <div class="sidebar-user">
    <div class="sidebar-user-name" id="sidebarName">‚Äî</div>
    <div class="sidebar-user-role" id="sidebarRole">‚Äî</div>
    <button class="btn btn-ghost btn-sm btn-full" onclick="doLogout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>
</nav>

<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <button class="hamburger" onclick="toggleMobileMenu()"><span></span><span></span><span></span></button>
      <div class="topbar-title">Siam Palette Group</div>
    </div>
    <div class="topbar-right">
      <div class="badge badge-surface" id="topDate">üìÖ Loading...</div>
      <div class="badge badge-green"><span class="live-dot"></span> Live</div>
    </div>
  </div>
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileMenu()"></div>

  <!-- DASHBOARD PAGES -->
  <div class="page active" id="page-overview"><div class="section-title">üìä Dashboard Overview</div><div class="data-source"><div class="gs">G</div>Live from Google Sheets</div><div id="overviewContent"><div class="loading"><div class="spinner"></div>Connecting to Google Sheets...</div></div></div>
  <div class="page" id="page-pnl"><div class="section-title">üí∞ Profit & Loss Statement</div><div class="data-source"><div class="gs">G</div>Live from Google Sheets</div><div id="pnlContent"><div class="loading"><div class="spinner"></div>Loading...</div></div></div>
  <div class="page" id="page-brands"><div class="section-title">üè™ Brand Performance</div><div class="data-source"><div class="gs">G</div>Live from Google Sheets</div><div id="brandsContent"><div class="loading"><div class="spinner"></div>Loading...</div></div></div>
  <div class="page" id="page-melting"><div class="section-title">üßÄ The Melting Cheese ‚Äî Deep Dive</div><div class="data-source"><div class="gs">G</div>Live from Google Sheets</div><div id="meltingContent"><div class="loading"><div class="spinner"></div>Loading...</div></div></div>
  <div class="page" id="page-traffic"><div class="section-title">üö∂ Foot Traffic Analytics</div><div class="data-source"><div class="gs">G</div>Live from Google Sheets</div><div id="trafficContent"><div class="loading"><div class="spinner"></div>Loading...</div></div></div>
  <div class="page" id="page-heatmap"><div class="section-title">üî• Traffic Heatmap</div><div class="data-source"><div class="gs">G</div>Live from Google Sheets</div><div id="heatmapContent"><div class="loading"><div class="spinner"></div>Loading...</div></div></div>
  <div class="page" id="page-marketing"><div class="section-title">üì± Social Media & Campaigns</div><div class="data-source"><div class="gs">G</div>Live from Google Sheets</div><div id="marketingContent"><div class="loading"><div class="spinner"></div>Loading...</div></div></div>

  <!-- DATA ENTRY: DAILY SALES -->
  <div class="page" id="page-entry-daily">
    <div class="section-title">üìù ‡∏Å‡∏£‡∏≠‡∏Å Daily Sales</div>
    <div class="section-desc">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô ‚Äî ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤ Google Sheets ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
    <div class="form-card">
      <div class="form-row">
        <div class="form-group"><label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" class="form-input" id="dDate"></div>
        <div class="form-group"><label class="form-label">Brand</label>
          <select class="form-input" id="dBrand" onchange="updateLocation()">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Brand ‚Äî</option>
            <option>Mango Coco</option><option>Issho Cafe</option><option>Golden Brown</option>
            <option>Red Wok</option><option>The Melting Cheese</option>
          </select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Location</label>
          <select class="form-input" id="dLocation">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Location ‚Äî</option>
          </select></div>
        <div class="form-group"><label class="form-label">Transactions (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</label><input type="number" class="form-input" id="dTxn" placeholder="0" min="0"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Revenue ($)</label><input type="number" class="form-input" id="dRev" placeholder="0" min="0" step="0.01"></div>
        <div class="form-group"><label class="form-label">COGS ($)</label><input type="number" class="form-input" id="dCogs" placeholder="0" min="0" step="0.01"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Labour ($)</label><input type="number" class="form-input" id="dLabour" placeholder="0" min="0" step="0.01"></div>
        <div class="form-group"><label class="form-label">Other Costs ($)</label><input type="number" class="form-input" id="dOther" placeholder="0" min="0" step="0.01"></div>
      </div>
      <div class="form-row-1">
        <div class="form-group"><label class="form-label">Foot Traffic (Covers)</label><input type="number" class="form-input" id="dTraffic" placeholder="0" min="0"></div>
      </div>
      <div class="form-actions">
        <button class="btn btn-gold" onclick="submitDaily()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button class="btn btn-ghost" onclick="clearDailyForm()">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
      </div>
    </div>
  </div>

  <!-- DATA ENTRY: SOCIAL MEDIA -->
  <div class="page" id="page-entry-social">
    <div class="section-title">üì∏ ‡∏Å‡∏£‡∏≠‡∏Å Social Media</div>
    <div class="section-desc">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Social Media ‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</div>
    <div class="form-card">
      <div class="form-row">
        <div class="form-group"><label class="form-label">Week Start (‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå)</label><input type="date" class="form-input" id="sWeek"></div>
        <div class="form-group"><label class="form-label">Brand</label>
          <select class="form-input" id="sBrand"><option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî</option>
            <option>Mango Coco</option><option>Issho Cafe</option><option>Golden Brown</option>
            <option>Red Wok</option><option>The Melting Cheese</option>
          </select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Platform</label>
          <select class="form-input" id="sPlatform"><option>Instagram</option><option>TikTok</option><option>Facebook</option></select></div>
        <div class="form-group"><label class="form-label">Followers</label><input type="number" class="form-input" id="sFollowers" placeholder="0" min="0"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Engagement Rate (%)</label><input type="number" class="form-input" id="sEngagement" placeholder="0" min="0" step="0.1"></div>
        <div class="form-group"><label class="form-label">Reach</label><input type="number" class="form-input" id="sReach" placeholder="0" min="0"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Website Clicks</label><input type="number" class="form-input" id="sClicks" placeholder="0" min="0"></div>
        <div class="form-group"><label class="form-label">Promo Code Redemptions</label><input type="number" class="form-input" id="sPromos" placeholder="0" min="0"></div>
      </div>
      <div class="form-actions">
        <button class="btn btn-gold" onclick="submitSocial()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button class="btn btn-ghost" onclick="clearForm('page-entry-social')">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
      </div>
    </div>
  </div>

  <!-- DATA ENTRY: CAMPAIGN -->
  <div class="page" id="page-entry-campaign">
    <div class="section-title">üì£ ‡πÄ‡∏û‡∏¥‡πà‡∏° Campaign</div>
    <div class="section-desc">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Campaign ‡πÉ‡∏´‡∏°‡πà</div>
    <div class="form-card">
      <div class="form-row-1"><div class="form-group"><label class="form-label">Campaign Name</label><input type="text" class="form-input" id="cName" placeholder="‡∏ä‡∏∑‡πà‡∏≠ campaign"></div></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Brand</label>
          <select class="form-input" id="cBrand"><option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî</option>
            <option>Mango Coco</option><option>Issho Cafe</option><option>Golden Brown</option>
            <option>Red Wok</option><option>The Melting Cheese</option><option>SPG Group</option>
          </select></div>
        <div class="form-group"><label class="form-label">Channel</label>
          <select class="form-input" id="cChannel"><option>Instagram Ads</option><option>TikTok Ads</option>
            <option>Google Ads</option><option>Facebook Ads</option><option>Influencer</option><option>In-store</option><option>Other</option>
          </select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Start Date</label><input type="date" class="form-input" id="cStart"></div>
        <div class="form-group"><label class="form-label">End Date</label><input type="date" class="form-input" id="cEnd"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Budget ($)</label><input type="number" class="form-input" id="cBudget" placeholder="0" min="0" step="0.01"></div>
        <div class="form-group"><label class="form-label">Est. Revenue ($)</label><input type="number" class="form-input" id="cRevenue" placeholder="0" min="0" step="0.01"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Status</label>
          <select class="form-input" id="cStatus"><option>Planned</option><option>Active</option><option>Completed</option><option>Cancelled</option></select></div>
        <div class="form-group"><label class="form-label">Notes</label><input type="text" class="form-input" id="cNotes" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"></div>
      </div>
      <div class="form-actions">
        <button class="btn btn-gold" onclick="submitCampaign()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button class="btn btn-ghost" onclick="clearForm('page-entry-campaign')">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
      </div>
    </div>
  </div>

  <!-- ADMIN: USER MANAGEMENT -->
  <div class="page" id="page-admin-users">
    <div class="section-title">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div>
    <div class="section-desc">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‚Äî ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin</div>
    <div class="card" style="margin-bottom:24px">
      <div class="card-header"><div class="card-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</div></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Username</label><input type="text" class="form-input" id="nuUser" placeholder="username"></div>
        <div class="form-group"><label class="form-label">Password</label><input type="text" class="form-input" id="nuPass" placeholder="min 6 ‡∏ï‡∏±‡∏ß"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á</label><input type="text" class="form-input" id="nuName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•"></div>
        <div class="form-group"><label class="form-label">Role</label>
          <select class="form-input" id="nuRole"><option value="editor">Editor (‡∏Å‡∏£‡∏≠‡∏Å+‡∏î‡∏π)</option><option value="viewer">Viewer (‡∏î‡∏π‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</option><option value="admin">Admin (‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á)</option></select></div>
      </div>
      <button class="btn btn-green btn-sm" onclick="addUser()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
    </div>
    <div class="card"><div class="card-header"><div class="card-title">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div><div id="usersTable"><div class="loading"><div class="spinner"></div></div></div></div>
  </div>

</div>
</div>

<script>
// ============================================================
// CONFIG ‚Äî ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô API_URL ‡∏´‡∏•‡∏±‡∏á Deploy Apps Script
// ============================================================
const API_URL = 'https://script.google.com/macros/s/AKfycbxizS9qOh8OZD-Po2sONMjXwKyJ_1X_qek0NNmoSp424cMPS61abTPA3VrXQnbhsb4f/exec';

const SHEETS = {
  daily:'https://docs.google.com/spreadsheets/d/e/2PACX-1vQo0B5K0iPoak-ujK-uM-Gnrw3rdbfiwPs5w0ILMjaDd3iTtXeDl7WXYbfIXAzPQR7TNhiFipgaYw56/pub?gid=981025724&single=true&output=csv',
  monthly:'https://docs.google.com/spreadsheets/d/e/2PACX-1vQo0B5K0iPoak-ujK-uM-Gnrw3rdbfiwPs5w0ILMjaDd3iTtXeDl7WXYbfIXAzPQR7TNhiFipgaYw56/pub?gid=1702600182&single=true&output=csv',
  pnl:'https://docs.google.com/spreadsheets/d/e/2PACX-1vQo0B5K0iPoak-ujK-uM-Gnrw3rdbfiwPs5w0ILMjaDd3iTtXeDl7WXYbfIXAzPQR7TNhiFipgaYw56/pub?gid=649699655&single=true&output=csv',
  social:'https://docs.google.com/spreadsheets/d/e/2PACX-1vQo0B5K0iPoak-ujK-uM-Gnrw3rdbfiwPs5w0ILMjaDd3iTtXeDl7WXYbfIXAzPQR7TNhiFipgaYw56/pub?gid=867020965&single=true&output=csv',
  campaign:'https://docs.google.com/spreadsheets/d/e/2PACX-1vQo0B5K0iPoak-ujK-uM-Gnrw3rdbfiwPs5w0ILMjaDd3iTtXeDl7WXYbfIXAzPQR7TNhiFipgaYw56/pub?gid=776319456&single=true&output=csv',
};

const BC = {'Mango Coco':'#f59e0b','Issho Cafe':'#22c55e','Golden Brown':'#d97706','Red Wok (Myer FC)':'#ef4444','Red Wok (Macquarie FC)':'#f97316','The Melting Cheese':'#eab308'};
const LOCATIONS = {'Mango Coco':['Myer FC'],'Issho Cafe':['Myer FC'],'Golden Brown':['Myer FC'],'Red Wok':['Myer FC','Macquarie FC'],'The Melting Cheese':['Myer FC']};

let DATA = {}, charts = {}, currentUser = null;

// ============================================================
// AUTH
// ============================================================
function getToken() { return localStorage.getItem('spg_token'); }
function setToken(t) { localStorage.setItem('spg_token', t); }
function clearToken() { localStorage.removeItem('spg_token'); localStorage.removeItem('spg_user'); }
function getStoredUser() { try { return JSON.parse(localStorage.getItem('spg_user')); } catch { return null; } }

async function apiCall(action, data = {}) {
  data.action = action;
  data.token = getToken();
  try {
    const resp = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' }, // Apps Script quirk
      body: JSON.stringify(data),
      redirect: 'follow'
    });
    return await resp.json();
  } catch (err) {
    console.error('[API]', err);
    return { success: false, error: err.message };
  }
}

async function doLogin() {
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value;
  const errEl = document.getElementById('loginError');
  const btn = document.getElementById('loginBtn');

  if (!user || !pass) { errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å username ‡πÅ‡∏•‡∏∞ password'; return; }

  btn.disabled = true; btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...'; errEl.textContent = '';

  if (API_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL_HERE') {
    errEl.textContent = '‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á API_URL ‚Äî ‡∏î‡∏π‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå apps-script.gs';
    btn.disabled = false; btn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'; return;
  }

  const result = await apiCall('login', { username: user, password: pass });

  if (result.success) {
    setToken(result.token);
    localStorage.setItem('spg_user', JSON.stringify(result.user));
    currentUser = result.user;
    enterApp();
  } else {
    errEl.textContent = result.error || '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
  }
  btn.disabled = false; btn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
}

async function doLogout() {
  await apiCall('logout');
  clearToken();
  currentUser = null;
  document.getElementById('loginOverlay').classList.remove('hidden');
  document.getElementById('mainApp').classList.remove('show');
}

async function checkAuth() {
  const token = getToken();
  if (!token) return false;
  const stored = getStoredUser();
  if (stored) { currentUser = stored; return true; } // Fast path
  const result = await apiCall('verify');
  if (result.success) { currentUser = result.user; return true; }
  clearToken();
  return false;
}

function enterApp() {
  document.getElementById('loginOverlay').classList.add('hidden');
  document.getElementById('mainApp').classList.add('show');
  document.getElementById('sidebarName').textContent = currentUser.displayName || currentUser.username;
  document.getElementById('sidebarRole').textContent = currentUser.role === 'admin' ? 'üëë Admin' : currentUser.role === 'editor' ? 'üìù Editor' : 'üëÅ Viewer';

  // Role-based visibility
  const isAdmin = currentUser.role === 'admin';
  const canEdit = currentUser.role !== 'viewer';

  document.getElementById('adminSection').style.display = isAdmin ? '' : 'none';
  document.getElementById('adminUsersBtn').style.display = isAdmin ? '' : 'none';
  document.getElementById('entrySection').style.display = canEdit ? '' : 'none';
  document.getElementById('entryDailyBtn').style.display = canEdit ? '' : 'none';
  document.getElementById('entrySocialBtn').style.display = canEdit ? '' : 'none';
  document.getElementById('entryCampaignBtn').style.display = canEdit ? '' : 'none';

  // Set default date
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('dDate').value = today;

  fetchDashboard();
}

// Enter key on login
document.getElementById('loginPass').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
document.getElementById('loginUser').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('loginPass').focus(); });

// ============================================================
// TOAST
// ============================================================
function toast(msg, type = 'success') {
  const el = document.createElement('div');
  el.className = 'toast toast-' + type;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
}

// ============================================================
// LOCATION DROPDOWN
// ============================================================
function updateLocation() {
  const brand = document.getElementById('dBrand').value;
  const locSel = document.getElementById('dLocation');
  locSel.innerHTML = '<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Location ‚Äî</option>';
  (LOCATIONS[brand] || []).forEach(l => { locSel.innerHTML += `<option>${l}</option>`; });
  if (LOCATIONS[brand] && LOCATIONS[brand].length === 1) locSel.value = LOCATIONS[brand][0];
}

// ============================================================
// FORM SUBMISSIONS
// ============================================================
async function submitDaily() {
  const d = id => document.getElementById(id).value;
  if (!d('dDate') || !d('dBrand') || !d('dLocation') || !d('dRev')) { toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error'); return; }
  const result = await apiCall('addDaily', { rows: [{
    date: d('dDate'), brand: d('dBrand'), location: d('dLocation'),
    transactions: d('dTxn'), revenue: d('dRev'), cogs: d('dCogs'),
    labour: d('dLabour'), otherCosts: d('dOther'), footTraffic: d('dTraffic')
  }]});
  if (result.success) { toast('‚úÖ ' + result.message); clearDailyForm(); } else { toast('‚ùå ' + result.error, 'error'); }
}

async function submitSocial() {
  const d = id => document.getElementById(id).value;
  if (!d('sWeek') || !d('sBrand')) { toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error'); return; }
  const result = await apiCall('addSocial', { rows: [{
    weekStart: d('sWeek'), brand: d('sBrand'), platform: d('sPlatform'),
    followers: d('sFollowers'), engagementRate: d('sEngagement'),
    reach: d('sReach'), clicks: d('sClicks'), promos: d('sPromos')
  }]});
  if (result.success) { toast('‚úÖ ' + result.message); clearForm('page-entry-social'); } else { toast('‚ùå ' + result.error, 'error'); }
}

async function submitCampaign() {
  const d = id => document.getElementById(id).value;
  if (!d('cName') || !d('cBrand')) { toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error'); return; }
  const result = await apiCall('addCampaign', { row: {
    name: d('cName'), brand: d('cBrand'), startDate: d('cStart'), endDate: d('cEnd'),
    channel: d('cChannel'), budget: d('cBudget'), estRevenue: d('cRevenue'),
    status: d('cStatus'), notes: d('cNotes')
  }});
  if (result.success) { toast('‚úÖ ' + result.message); clearForm('page-entry-campaign'); } else { toast('‚ùå ' + result.error, 'error'); }
}

function clearDailyForm() {
  ['dTxn','dRev','dCogs','dLabour','dOther','dTraffic'].forEach(id => document.getElementById(id).value = '');
}
function clearForm(pageId) {
  document.querySelectorAll('#' + pageId + ' .form-input').forEach(el => {
    if (el.tagName === 'SELECT') el.selectedIndex = 0; else if (el.type !== 'date') el.value = '';
  });
}

// ============================================================
// ADMIN: USER MANAGEMENT
// ============================================================
async function addUser() {
  const d = id => document.getElementById(id).value;
  if (!d('nuUser') || !d('nuPass') || !d('nuName')) { toast('‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error'); return; }
  const result = await apiCall('addUser', { username: d('nuUser'), password: d('nuPass'), displayName: d('nuName'), role: d('nuRole') });
  if (result.success) { toast('‚úÖ ' + result.message); ['nuUser','nuPass','nuName'].forEach(id => document.getElementById(id).value = ''); loadUsers(); }
  else toast('‚ùå ' + result.error, 'error');
}

async function loadUsers() {
  const result = await apiCall('getUsers');
  if (!result.success) { document.getElementById('usersTable').innerHTML = '<div class="alert-banner alert-error">‚ùå ' + result.error + '</div>'; return; }
  let h = '<table class="data-table"><thead><tr><th>Username</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>Role</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody>';
  result.users.forEach(u => {
    h += `<tr><td style="color:var(--text);font-weight:600">${u.username}</td><td>${u.displayName}</td>
      <td><span class="user-badge ${u.role}">${u.role}</span></td>
      <td><span class="status-dot ${u.active?'active':'inactive'}"></span>${u.active?'Active':'Disabled'}</td>
      <td>${u.username!=='admin'?`<button class="btn btn-ghost btn-sm" onclick="toggleUser('${u.username}',${!u.active})">${u.active?'‡∏õ‡∏¥‡∏î':'‡πÄ‡∏õ‡∏¥‡∏î'}</button>
        <button class="btn btn-red btn-sm" onclick="deleteUser('${u.username}')">‡∏•‡∏ö</button>`:'-'}</td></tr>`;
  });
  h += '</tbody></table>';
  document.getElementById('usersTable').innerHTML = h;
}

async function toggleUser(username, active) {
  const r = await apiCall('updateUser', { targetUser: username, active: active });
  if (r.success) { toast('‚úÖ ' + r.message); loadUsers(); } else toast('‚ùå ' + r.error, 'error');
}

async function deleteUser(username) {
  if (!confirm('‡∏•‡∏ö ' + username + ' ?')) return;
  const r = await apiCall('deleteUser', { targetUser: username });
  if (r.success) { toast('‚úÖ ' + r.message); loadUsers(); } else toast('‚ùå ' + r.error, 'error');
}

// ============================================================
// CSV PARSER + DASHBOARD (same as before)
// ============================================================
function parseCSV(t){const rows=[];let i=0,n=t.length;while(i<n){const row=[];while(i<n){let c='';if(i<n&&t[i]==='"'){i++;while(i<n){if(t[i]==='"'){if(i+1<n&&t[i+1]==='"'){c+='"';i+=2}else{i++;break}}else{c+=t[i];i++}}while(i<n&&t[i]!==','&&t[i]!=='\n'&&t[i]!=='\r')i++}else{while(i<n&&t[i]!==','&&t[i]!=='\n'&&t[i]!=='\r'){c+=t[i];i++}}row.push(c.trim());if(i<n&&t[i]===','){i++;continue}break}if(i<n&&t[i]==='\r')i++;if(i<n&&t[i]==='\n')i++;if(row.length>1||(row.length===1&&row[0]!==''))rows.push(row)}return rows}
function findHdr(rows,kw){const k=kw.toLowerCase();for(let i=0;i<Math.min(rows.length,10);i++){for(let j=0;j<rows[i].length;j++){const v=(rows[i][j]||'').trim().toLowerCase();if(v===k&&rows[i].filter(x=>x&&x.trim()).length>=3)return i}}return 0}
function toRec(rows,hi){const h=rows[hi],rec=[];for(let i=hi+1;i<rows.length;i++){if(!rows[i]||rows[i].every(c=>!c))continue;const o={};h.forEach((k,j)=>{if(k)o[k.trim()]=(rows[i][j]||'').trim()});rec.push(o)}return rec}

async function fetchDashboard(){
  try{
    const results=await Promise.all(Object.entries(SHEETS).map(async([name,url])=>{
      const r=await fetch(url+'&_t='+Date.now(),{mode:'cors',credentials:'omit',redirect:'follow'});
      if(!r.ok)throw new Error(name+': HTTP '+r.status);
      const txt=await r.text();
      if(txt.trim().startsWith('<!DOCTYPE')||txt.trim().startsWith('<html'))throw new Error(name+': Got HTML not CSV');
      return txt;
    }));
    let rows,hi;
    rows=parseCSV(results[0]);hi=findHdr(rows,'Date');DATA.daily=toRec(rows,hi);
    rows=parseCSV(results[1]);hi=findHdr(rows,'Month');DATA.monthly=toRec(rows,hi);
    DATA.pnlRaw=parseCSV(results[2]);
    rows=parseCSV(results[3]);hi=findHdr(rows,'Week Start');DATA.social=toRec(rows,hi);
    rows=parseCSV(results[4]);hi=findHdr(rows,'Start Date');DATA.campaign=toRec(rows,hi);
    console.log('[SPG] Daily:',DATA.daily.length,'Monthly:',DATA.monthly.length);

    const months=[...new Set(DATA.monthly.map(r=>r['Month']))].filter(Boolean).sort();
    DATA.latestMonth=months[months.length-1]||'2026-02';
    DATA.prevMonth=months.length>1?months[months.length-2]:null;
    DATA.allMonths=months;
    const[y,m]=DATA.latestMonth.split('-');
    document.getElementById('topDate').textContent='üìÖ '+['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][parseInt(m)]+' '+y;
    renderAll();
  }catch(err){
    console.error('[SPG]',err);
    document.getElementById('overviewContent').innerHTML=`<div class="alert-banner alert-error">‚ùå ${err.message}</div>`;
  }
}

function num(v){return parseFloat(String(v).replace(/[$,%\s]/g,''))||0}
function numPct(v){const s=String(v).trim(),n=parseFloat(s.replace(/[%$,\s]/g,''));if(isNaN(n))return 0;return s.includes('%')?n/100:(n>1?n/100:n)}
function fmt(n){return'$'+Math.round(n).toLocaleString('en-US')}
function fmtN(n){return Math.round(n).toLocaleString('en-US')}
function fmtPct(n){return(n*100).toFixed(1)+'%'}
function pctCh(c,p){return p?((c-p)/Math.abs(p)):0}
function chgH(p){if(!isFinite(p))return'';const cl=p>=0?'up':'down',ar=p>=0?'‚Üë':'‚Üì';return`<span class="stat-change ${cl}">${ar} ${Math.abs(p*100).toFixed(1)}%</span>`}
function dc(id){if(charts[id]){charts[id].destroy();delete charts[id]}}
function gMB(m){return DATA.monthly.filter(r=>r['Month']===m)}
function sF(rec,f){return rec.reduce((s,r)=>s+num(r[f]),0)}
function mLbl(m){return['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][parseInt(m.split('-')[1])]}

function renderAll(){renderOverview();renderPnL();renderBrands();renderMelting();renderTraffic();renderHeatmap();renderMarketing()}

function renderOverview(){
  const c=gMB(DATA.latestMonth),p=DATA.prevMonth?gMB(DATA.prevMonth):[];
  const tR=sF(c,'Total Revenue ($)'),tC=sF(c,'Total Costs ($)'),tP=sF(c,'Net Profit ($)'),tT=sF(c,'Foot Traffic');
  const pR=sF(p,'Total Revenue ($)'),pC=sF(p,'Total Costs ($)'),pP=sF(p,'Net Profit ($)'),pT=sF(p,'Foot Traffic');
  const mg=tR>0?tP/tR:0;
  let h=`<div class="grid grid-4">
    <div class="card"><div class="card-header"><div class="card-title">Total Revenue</div><div class="card-icon" style="background:var(--green-dim)">üíµ</div></div><div class="stat-value">${fmt(tR)}</div>${chgH(pctCh(tR,pR))}<div class="stat-sub">vs prev: ${fmt(pR)}</div></div>
    <div class="card"><div class="card-header"><div class="card-title">Total Costs</div><div class="card-icon" style="background:var(--red-dim)">üìâ</div></div><div class="stat-value">${fmt(tC)}</div>${chgH(pctCh(tC,pC))}</div>
    <div class="card"><div class="card-header"><div class="card-title">Net Profit</div><div class="card-icon" style="background:var(--gold-dim)">‚ú®</div></div><div class="stat-value" style="color:${tP>=0?'var(--green)':'var(--red)'}">${fmt(tP)}</div>${chgH(pctCh(tP,pP))}<div class="stat-sub">Margin: ${fmtPct(mg)}</div></div>
    <div class="card"><div class="card-header"><div class="card-title">Foot Traffic</div><div class="card-icon" style="background:var(--blue-dim)">üö∂</div></div><div class="stat-value">${fmtN(tT)}</div>${chgH(pctCh(tT,pT))}</div>
  </div>`;
  h+=`<div class="grid grid-2-1"><div class="card"><div class="card-header"><div class="card-title">Revenue vs Costs Trend</div></div><div class="chart-container"><canvas id="c1"></canvas></div></div><div class="card"><div class="card-header"><div class="card-title">Revenue by Brand</div></div><div class="chart-container"><canvas id="c2"></canvas></div></div></div>`;
  const tmc=c.find(r=>r['Brand']==='The Melting Cheese');
  if(tmc)h+=`<div class="alert-banner alert-warning">‚ö†Ô∏è <strong>The Melting Cheese:</strong> Margin ${fmtPct(numPct(tmc['Margin (%)']))} ‚Äî Revenue ${fmt(num(tmc['Total Revenue ($)']))}</div>`;
  document.getElementById('overviewContent').innerHTML=h;
  const rc=DATA.allMonths.slice(-6),lb=rc.map(m=>mLbl(m)+' '+m.split('-')[0].slice(2));
  dc('c1');charts['c1']=new Chart(document.getElementById('c1'),{type:'line',data:{labels:lb,datasets:[{label:'Revenue',data:rc.map(m=>sF(gMB(m),'Total Revenue ($)')),borderColor:'#22c55e',backgroundColor:'rgba(34,197,94,.08)',fill:true,tension:.4,pointRadius:4},{label:'Costs',data:rc.map(m=>sF(gMB(m),'Total Costs ($)')),borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,.05)',fill:true,tension:.4,pointRadius:4}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{ticks:{callback:v=>'$'+(v/1000).toFixed(0)+'K'}}}}});
  dc('c2');charts['c2']=new Chart(document.getElementById('c2'),{type:'doughnut',data:{labels:c.map(r=>r['Brand']),datasets:[{data:c.map(r=>num(r['Total Revenue ($)'])),backgroundColor:c.map(r=>BC[r['Brand']]||'#71717a'),borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,cutout:'60%',plugins:{legend:{position:'right',labels:{padding:8,font:{size:10}}}}}});
}

function renderPnL(){
  const c=gMB(DATA.latestMonth),tR=sF(c,'Total Revenue ($)'),tCG=sF(c,'Total COGS ($)'),tLB=sF(c,'Total Labour ($)'),tOT=sF(c,'Total Other ($)'),tC=tCG+tLB+tOT,pr=tR-tC,mg=tR>0?pr/tR:0;
  let h=`<div class="grid grid-2"><div class="card"><h3 style="font-size:15px;font-weight:600;margin-bottom:16px">SPG P&L ‚Äî ${DATA.latestMonth}</h3>`;
  c.forEach(r=>{h+=`<div class="pnl-row"><span class="pnl-label">${r['Brand']}</span><span class="pnl-value">${fmt(num(r['Total Revenue ($)']))}</span></div>`});
  h+=`<div class="pnl-row total"><span class="pnl-label">Total Revenue</span><span class="pnl-value" style="color:var(--green)">${fmt(tR)}</span></div><div style="height:20px"></div>`;
  h+=`<div class="pnl-row"><span class="pnl-label">COGS</span><span class="pnl-value" style="color:var(--red)">-${fmt(tCG)}</span></div>`;
  h+=`<div class="pnl-row"><span class="pnl-label">Labour</span><span class="pnl-value" style="color:var(--red)">-${fmt(tLB)}</span></div>`;
  h+=`<div class="pnl-row"><span class="pnl-label">Other</span><span class="pnl-value" style="color:var(--red)">-${fmt(tOT)}</span></div>`;
  h+=`<div class="pnl-row total"><span class="pnl-label">Total Expenses</span><span class="pnl-value" style="color:var(--red)">-${fmt(tC)}</span></div><div style="height:16px"></div>`;
  h+=`<div class="pnl-row total" style="background:var(--gold-dim);padding:16px 20px;border-radius:var(--radius-sm)"><span class="pnl-label" style="color:var(--gold);font-size:16px">‚ú® Net Profit</span><span class="pnl-value" style="color:var(--gold);font-size:24px">${fmt(pr)}</span></div><div style="text-align:right;margin-top:8px;font-size:13px;color:var(--text-muted)">Margin: ${fmtPct(mg)}</div></div>`;
  h+=`<div><div class="card" style="margin-bottom:16px"><div class="card-header"><div class="card-title">Cost Breakdown</div></div><div class="chart-container-sm"><canvas id="c3"></canvas></div></div><div class="card"><div class="card-header"><div class="card-title">Margin by Brand</div></div><div class="chart-container-sm"><canvas id="c4"></canvas></div></div></div></div>`;
  document.getElementById('pnlContent').innerHTML=h;
  dc('c3');charts['c3']=new Chart(document.getElementById('c3'),{type:'doughnut',data:{labels:['COGS','Labour','Other'],datasets:[{data:[tCG,tLB,tOT],backgroundColor:['#ef4444','#f97316','#71717a'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,cutout:'55%',plugins:{legend:{position:'bottom'}}}});
  dc('c4');charts['c4']=new Chart(document.getElementById('c4'),{type:'bar',data:{labels:c.map(r=>r['Brand'].length>15?r['Brand'].replace('(','\n('):r['Brand']),datasets:[{data:c.map(r=>numPct(r['Margin (%)'])*100),backgroundColor:c.map(r=>BC[r['Brand']]||'#71717a'),borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false}},scales:{x:{beginAtZero:true,max:40,ticks:{callback:v=>v+'%'}}}}});
}

function renderBrands(){
  const c=gMB(DATA.latestMonth),p=DATA.prevMonth?gMB(DATA.prevMonth):[];
  let tr='';c.forEach(r=>{const b=r['Brand'],rv=num(r['Total Revenue ($)']),tx=num(r['Total Transactions']),av=tx>0?rv/tx:0,tf=num(r['Foot Traffic']),mp=numPct(r['Margin (%)'])*100;const pb=p.find(x=>x['Brand']===b);const ch=pctCh(rv,pb?num(pb['Total Revenue ($)']):0);tr+=`<tr><td><div class="brand-cell"><div class="brand-dot" style="background:${BC[b]||'#71717a'}"></div>${b}</div></td><td style="font-weight:600;color:var(--text)">${fmt(rv)}</td><td>${fmtN(tx)}</td><td>$${av.toFixed(2)}</td><td>${fmtN(tf)}</td><td class="${ch>=0?'val-positive':'val-negative'}">${ch>=0?'+':''}${(ch*100).toFixed(1)}%</td><td>${mp.toFixed(1)}%</td></tr>`});
  let h=`<div class="card" style="margin-bottom:24px;overflow-x:auto"><table class="data-table"><thead><tr><th>Brand</th><th>Revenue</th><th>Txns</th><th>Avg $</th><th>Traffic</th><th>vs Prev</th><th>Margin</th></tr></thead><tbody>${tr}</tbody></table></div>`;
  h+=`<div class="card"><div class="card-header"><div class="card-title">Revenue Trend</div></div><div class="chart-container"><canvas id="c5"></canvas></div></div>`;
  document.getElementById('brandsContent').innerHTML=h;
  const rc=DATA.allMonths.slice(-6),lb=rc.map(mLbl),br=[...new Set(c.map(r=>r['Brand']))];
  dc('c5');charts['c5']=new Chart(document.getElementById('c5'),{type:'line',data:{labels:lb,datasets:br.map(b=>({label:b,data:rc.map(m=>{const r=DATA.monthly.find(x=>x['Month']===m&&x['Brand']===b);return r?num(r['Total Revenue ($)']):0}),borderColor:BC[b]||'#71717a',tension:.4,pointRadius:3}))},options:{responsive:true,maintainAspectRatio:false,scales:{y:{ticks:{callback:v=>'$'+(v/1000).toFixed(0)+'K'}}}}});
}

function renderMelting(){
  const c=DATA.monthly.find(r=>r['Month']===DATA.latestMonth&&r['Brand']==='The Melting Cheese'),p=DATA.prevMonth?DATA.monthly.find(r=>r['Month']===DATA.prevMonth&&r['Brand']==='The Melting Cheese'):null;
  if(!c){document.getElementById('meltingContent').innerHTML='<div class="alert-banner alert-warning">No TMC data</div>';return}
  const rv=num(c['Total Revenue ($)']),tx=num(c['Total Transactions']),tf=num(c['Foot Traffic']),av=tx>0?rv/tx:0;
  let h=`<div class="grid grid-4"><div class="card"><div class="card-title">Revenue</div><div class="stat-value" style="font-size:24px">${fmt(rv)}</div>${chgH(pctCh(rv,p?num(p['Total Revenue ($)']):0))}</div><div class="card"><div class="card-title">Transactions</div><div class="stat-value" style="font-size:24px">${fmtN(tx)}</div></div><div class="card"><div class="card-title">Avg Spend</div><div class="stat-value" style="font-size:24px">$${av.toFixed(2)}</div></div><div class="card"><div class="card-title">Traffic</div><div class="stat-value" style="font-size:24px">${fmtN(tf)}</div></div></div>`;
  h+=`<div class="grid grid-2"><div class="card"><div class="card-header"><div class="card-title">TMC Daily ‚Äî ${DATA.latestMonth}</div></div><div class="chart-container"><canvas id="c6"></canvas></div></div><div class="card"><div class="card-header"><div class="card-title">TMC Trend</div></div><div class="chart-container"><canvas id="c7"></canvas></div></div></div>`;
  document.getElementById('meltingContent').innerHTML=h;
  const td=DATA.daily.filter(r=>r['Brand']==='The Melting Cheese'&&r['Date']&&r['Date'].startsWith(DATA.latestMonth));
  dc('c6');charts['c6']=new Chart(document.getElementById('c6'),{type:'bar',data:{labels:td.map(r=>r['Date'].split('-')[2]),datasets:[{data:td.map(r=>num(r['Revenue ($)'])),backgroundColor:'rgba(234,179,8,.4)',borderRadius:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
  const rc=DATA.allMonths.slice(-6);dc('c7');charts['c7']=new Chart(document.getElementById('c7'),{type:'line',data:{labels:rc.map(mLbl),datasets:[{data:rc.map(m=>{const r=DATA.monthly.find(x=>x['Month']===m&&x['Brand']==='The Melting Cheese');return r?num(r['Total Revenue ($)']):0}),borderColor:'#eab308',backgroundColor:'rgba(234,179,8,.1)',fill:true,tension:.4,pointRadius:5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
}

function renderTraffic(){
  const rc=DATA.allMonths.slice(-6),lb=rc.map(mLbl),td=rc.map(m=>sF(gMB(m),'Foot Traffic'));
  let h=`<div class="grid grid-2"><div class="card"><div class="card-header"><div class="card-title">Monthly Foot Traffic</div></div><div class="chart-container"><canvas id="c8"></canvas></div></div><div class="card"><div class="card-header"><div class="card-title">Traffic by Brand</div></div><div class="chart-container"><canvas id="c9"></canvas></div></div></div>`;
  h+=`<div class="card"><div class="card-header"><div class="card-title">Avg by Day of Week</div></div><div class="chart-container"><canvas id="c10"></canvas></div></div>`;
  document.getElementById('trafficContent').innerHTML=h;
  dc('c8');charts['c8']=new Chart(document.getElementById('c8'),{type:'line',data:{labels:lb,datasets:[{label:'Traffic',data:td,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.1)',fill:true,tension:.4,pointRadius:4}]},options:{responsive:true,maintainAspectRatio:false}});
  const c=gMB(DATA.latestMonth);dc('c9');charts['c9']=new Chart(document.getElementById('c9'),{type:'bar',data:{labels:c.map(r=>r['Brand'].length>15?r['Brand'].replace('(','\n('):r['Brand']),datasets:[{data:c.map(r=>num(r['Foot Traffic'])),backgroundColor:c.map(r=>BC[r['Brand']]||'#71717a'),borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
  const dN=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],dT=[0,0,0,0,0,0,0],dC=[0,0,0,0,0,0,0];
  DATA.daily.forEach(r=>{if(!r['Date'])return;const d=new Date(r['Date']),w=d.getDay();dT[w]+=num(r['Foot Traffic (Covers)']);dC[w]++});
  const dA=dT.map((t,i)=>dC[i]>0?Math.round(t/dC[i]):0),oA=[...dA.slice(1),dA[0]],oN=[...dN.slice(1),dN[0]];
  dc('c10');charts['c10']=new Chart(document.getElementById('c10'),{type:'bar',data:{labels:oN,datasets:[{data:oA,backgroundColor:oA.map((_,i)=>i>=4?'#22c55e':'#3b82f6'),borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
}

function renderHeatmap(){
  const dN=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],br=Object.keys(BC),mx={},ct={};
  br.forEach(b=>{mx[b]=[0,0,0,0,0,0,0];ct[b]=[0,0,0,0,0,0,0]});
  DATA.daily.forEach(r=>{if(!r['Date']||!r['Brand'])return;const d=new Date(r['Date']);let w=d.getDay()-1;if(w<0)w=6;let bk=r['Brand'];if(r['Brand']==='Red Wok')bk=r['Location']==='Macquarie FC'?'Red Wok (Macquarie FC)':'Red Wok (Myer FC)';if(mx[bk]){mx[bk][w]+=num(r['Foot Traffic (Covers)']);ct[bk][w]++}});
  br.forEach(b=>{for(let d=0;d<7;d++)mx[b][d]=ct[b][d]>0?Math.round(mx[b][d]/ct[b][d]):0});
  const mv=Math.max(...br.flatMap(b=>mx[b]),1);
  function grid(title,bl){let h=`<div class="card" style="margin-bottom:24px"><div class="card-header"><div class="card-title">${title}</div></div><div class="heatmap"><div></div>`;dN.forEach(d=>{h+=`<div class="heatmap-header">${d}</div>`});bl.forEach(b=>{h+=`<div class="heatmap-label">${b}</div>`;mx[b].forEach(v=>{const i=v/mv;h+=`<div class="heatmap-cell" style="background:rgba(234,${Math.round(179*i*.6)+80},${Math.round(8*i)+20},${.15+i*.7})" title="${v}">${v}</div>`})});return h+'</div></div>'}
  document.getElementById('heatmapContent').innerHTML=grid('All Brands',br)+grid('üßÄ TMC',['The Melting Cheese']);
}

function renderMarketing(){
  const wk=[...new Set(DATA.social.map(r=>r['Week Start']))].filter(Boolean).sort(),lw=wk[wk.length-1]||'',ls=DATA.social.filter(r=>r['Week Start']===lw);
  const tF=ls.reduce((s,r)=>s+num(r['Followers']),0),tR=ls.reduce((s,r)=>s+num(r['Reach']),0),tC=ls.reduce((s,r)=>s+num(r['Website Clicks']),0),tP=ls.reduce((s,r)=>s+num(r['Promo Code Redemptions']),0);
  let h=`<div class="grid grid-4"><div class="card"><div class="card-title">Followers</div><div class="stat-value" style="font-size:22px">${fmtN(tF)}</div></div><div class="card"><div class="card-title">Reach</div><div class="stat-value" style="font-size:22px">${fmtN(tR)}</div></div><div class="card"><div class="card-title">Clicks</div><div class="stat-value" style="font-size:22px">${fmtN(tC)}</div></div><div class="card"><div class="card-title">Promos</div><div class="stat-value" style="font-size:22px">${fmtN(tP)}</div></div></div>`;
  h+=`<div class="grid grid-2"><div class="card"><div class="card-header"><div class="card-title">IG Growth</div></div><div class="chart-container"><canvas id="c11"></canvas></div></div><div class="card"><div class="card-header"><div class="card-title">Campaigns</div></div>`;
  const cp=DATA.campaign.slice(-8);h+=`<div style="overflow-x:auto"><table class="data-table"><thead><tr><th>Campaign</th><th>Brand</th><th>Budget</th><th>Rev</th><th>ROI</th></tr></thead><tbody>`;
  cp.forEach(c=>{const b=num(c['Budget ($)']),r=num(c['Est. Revenue ($)']),roi=b>0?r/b:0;h+=`<tr><td style="font-size:11px;color:var(--text)">${c['Campaign Name']||''}</td><td style="font-size:11px">${c['Brand']||''}</td><td>${fmt(b)}</td><td>${fmt(r)}</td><td class="${roi>1?'val-positive':'val-negative'}">${roi.toFixed(1)}x</td></tr>`});
  h+=`</tbody></table></div></div></div>`;document.getElementById('marketingContent').innerHTML=h;
  const ig=DATA.social.filter(r=>r['Platform']==='Instagram'),iw=[...new Set(ig.map(r=>r['Week Start']))].filter(Boolean).sort().slice(-12),ib=[...new Set(ig.map(r=>r['Brand']))];
  dc('c11');charts['c11']=new Chart(document.getElementById('c11'),{type:'line',data:{labels:iw.map(w=>{const p=w.split('-');return p[1]+'/'+p[2]}),datasets:ib.map(b=>({label:b,data:iw.map(w=>{const r=ig.find(x=>x['Week Start']===w&&x['Brand']===b);return r?num(r['Followers']):0}),borderColor:BC[b]||'#71717a',tension:.4,pointRadius:2}))},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{font:{size:10}}}}}});
}

// ============================================================
// NAV
// ============================================================
function showPage(id,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.sidebar-item').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  if(btn)btn.classList.add('active');
  closeMobileMenu();
  window.scrollTo(0,0);
  if(id==='admin-users')loadUsers();
}
function toggleMobileMenu(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sidebarOverlay').classList.toggle('show')}
function closeMobileMenu(){document.getElementById('sidebar').classList.remove('open');document.getElementById('sidebarOverlay').classList.remove('show')}

Chart.defaults.color='#71717a';Chart.defaults.borderColor='#27272a';Chart.defaults.font.family='DM Sans';Chart.defaults.font.size=11;

// ============================================================
// INIT
// ============================================================
(async function(){
  const ok = await checkAuth();
  if(ok) enterApp();
})();
</script>
</body>
</html>
